name: Congress Daily Sync

on:
  schedule:
    - cron: '0 3 * * *'  # Run at 3:00 AM UTC daily
  workflow_dispatch:      # Allow manual trigger

jobs:
  congress-sync:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Trigger Congress Pipeline (Step Functions)
      run: |
        echo "Starting Congress.gov Pipeline..."
        
        # Start Step Functions execution and capture the ARN
        EXECUTION_ARN=$(aws stepfunctions start-execution \
          --state-machine-arn ${{ secrets.CONGRESS_STATE_MACHINE_ARN }} \
          --name "congress-daily-$(date +%Y%m%d-%H%M%S)" \
          --input "{\"execution_type\":\"scheduled\",\"data_type\":\"bills\"}" \
          --query 'executionArn' \
          --output text)
        
        echo "Execution started: $EXECUTION_ARN"
        
        # Wait for completion with timeout (2 hours max)
        START_TIME=$(date +%s)
        TIMEOUT_SECONDS=7200
        
        while true; do
          ELAPSED=$(($(date +%s) - START_TIME))
          
          if [ $ELAPSED -ge $TIMEOUT_SECONDS ]; then
            echo "⏱️ Pipeline execution timed out after $ELAPSED seconds"
            exit 1
          fi
          
          STATUS=$(aws stepfunctions describe-execution \
            --execution-arn "$EXECUTION_ARN" \
            --query 'status' \
            --output text)
          
          echo "[$ELAPSED s] Current status: $STATUS"
          
          if [ "$STATUS" = "SUCCEEDED" ]; then
            echo "✅ Pipeline completed successfully"
            
            # Get execution output
            OUTPUT=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'output' \
              --output text)
            echo "Execution output: $OUTPUT"
            exit 0
          elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "TIMED_OUT" ] || [ "$STATUS" = "ABORTED" ]; then
            echo "❌ Pipeline failed with status: $STATUS"
            
            # Get failure details
            ERROR=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'error' \
              --output text)
            CAUSE=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'cause' \
              --output text)
            
            echo "Error: $ERROR"
            echo "Cause: $CAUSE"
            exit 1
          fi
          
          # Wait 30 seconds before checking again
          sleep 30
        done

    - name: Upload Logs to S3
      if: always()
      run: |
        DATE=$(date +%Y-%m-%d)
        echo "Pipeline completed at $(date)" > /tmp/pipeline_log.txt
        aws s3 cp /tmp/pipeline_log.txt s3://congress-disclosures-standardized/logs/congress_pipeline/${DATE}.log

    - name: Notify on Failure
      if: failure()
      run: |
        echo "Congress pipeline failed! Check GitHub Actions logs."
        # Optional: Add Slack notification here

