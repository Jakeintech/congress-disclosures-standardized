name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.6.0"

jobs:
  # Lint and format check
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Check code formatting with Black
        run: black --check ingestion/ tests/
        continue-on-error: true  # Don't fail build on formatting

      - name: Lint with flake8
        run: |
          # stop the build if there are Python syntax errors or undefined names
          flake8 ingestion/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # exit-zero treats all errors as warnings
          flake8 ingestion/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
        continue-on-error: true  # Don't fail build on lint warnings

      - name: Type check with mypy
        run: mypy ingestion/ --ignore-missing-imports
        continue-on-error: true  # Don't fail build on type errors yet

      - name: Security scan with bandit
        run: bandit -r ingestion/ -ll
        continue-on-error: true  # Don't fail build on security warnings yet

  # Unit tests
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ingestion/requirements.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests with coverage
        run: |
          pytest tests/unit/ \
            --cov=ingestion \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=0 \
            -v
        continue-on-error: true  # Don't fail build on test failures during development

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Terraform validation
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infra/terraform/
        continue-on-error: true

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd infra/terraform
          terraform validate

  # Build Lambda packages (on main branch only)
  build-lambdas:
    name: Build Lambda Packages
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [lint, test-unit, terraform-validate]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Package ALL Lambda Functions
        run: |
          # Use Makefile to package all Lambdas consistently
          make package-all

      - name: Upload Lambda artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-packages
          path: ingestion/lambdas/*/function.zip
          retention-days: 30

  # Deploy (auto-deploys on push to main, or manual trigger)
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build-lambdas]
    environment:
      name: production
      url: https://console.aws.amazon.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Download Lambda artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-packages
          path: ingestion/lambdas/

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init

      - name: Terraform Plan
        run: |
          cd infra/terraform
          terraform plan -out=tfplan \
            -var="s3_bucket_name=congress-disclosures-standardized" \
            -var="budget_alert_email=${{ secrets.BUDGET_ALERT_EMAIL }}"

      - name: Terraform Apply
        run: |
          cd infra/terraform
          terraform apply tfplan

      - name: Upload API Keys to SSM Parameter Store
        run: |
          ENV="development"
          echo "üì¶ Uploading API keys to SSM Parameter Store..."

          # Congress API Key
          aws ssm put-parameter \
            --name "/congress-disclosures/${ENV}/congress_api_key" \
            --value "${{ secrets.CONGRESS_API_KEY }}" \
            --type "SecureString" \
            --overwrite || echo "‚ö†Ô∏è  Failed to update Congress API key"

          # Alpha Vantage API Key
          aws ssm put-parameter \
            --name "/congress-disclosures/${ENV}/alpha_vantage_api_key" \
            --value "${{ secrets.ALPHA_VANTAGE_API_KEY }}" \
            --type "SecureString" \
            --overwrite || echo "‚ö†Ô∏è  Failed to update Alpha Vantage API key"

          # Coinbase API Key
          aws ssm put-parameter \
            --name "/congress-disclosures/${ENV}/coinbase_api_key" \
            --value "${{ secrets.COINBASE_API_KEY }}" \
            --type "SecureString" \
            --overwrite || echo "‚ö†Ô∏è  Failed to update Coinbase API key"

          # Coinbase API Secret
          aws ssm put-parameter \
            --name "/congress-disclosures/${ENV}/coinbase_api_secret" \
            --value "${{ secrets.COINBASE_API_SECRET }}" \
            --type "SecureString" \
            --overwrite || echo "‚ö†Ô∏è  Failed to update Coinbase API secret"

          echo "‚úÖ API keys uploaded to SSM"

      - name: Upload Lambda packages to S3
        run: |
          for lambda_dir in ingestion/lambdas/*/; do
            lambda_name=$(basename $lambda_dir)
            if [ -f "$lambda_dir/function.zip" ]; then
              echo "Uploading $lambda_name to S3..."
              aws s3 cp "$lambda_dir/function.zip" \
                "s3://congress-disclosures-standardized/lambda-deployments/${lambda_name}/function.zip"
            fi
          done

      - name: Update Lambda function codes
        run: |
          ENV="development"  # Change to production when ready
          for lambda_dir in ingestion/lambdas/*/; do
            lambda_name=$(basename $lambda_dir)
            if [ -f "$lambda_dir/function.zip" ]; then
              echo "Updating Lambda: congress-disclosures-${ENV}-${lambda_name}"
              aws lambda update-function-code \
                --function-name "congress-disclosures-${ENV}-${lambda_name}" \
                --s3-bucket congress-disclosures-standardized \
                --s3-key "lambda-deployments/${lambda_name}/function.zip" \
                || echo "‚ö†Ô∏è  Lambda $lambda_name not found or update failed"
            fi
          done

      - name: Refresh Gold Layer Aggregates
        run: |
          echo "üîÑ Refreshing Gold layer aggregates..."
          python3 -m pip install boto3 pandas pyarrow
          python3 scripts/compute_agg_member_trading_stats_real.py || echo "Member stats refresh failed"
          # Add other gold aggregates here as you create them

      - name: Regenerate Website Manifests
        run: |
          echo "üìä Regenerating website data manifests..."
          python3 scripts/generate_all_gold_manifests.py

      - name: Deploy Website to S3
        run: |
          echo "üåê Deploying website..."
          aws s3 sync website/ s3://congress-disclosures-standardized/website/ \
            --exclude "data/*" \
            --cache-control "no-cache, no-store, must-revalidate" \
            --delete

          aws s3 sync website/data/ s3://congress-disclosures-standardized/website/data/ \
            --cache-control "no-cache, no-store, must-revalidate" \
            --delete

          echo "‚úÖ Full pipeline deployment complete!"
