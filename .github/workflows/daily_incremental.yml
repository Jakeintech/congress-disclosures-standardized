name: Daily Incremental Update

on:
  schedule:
    - cron: '0 6 * * *'  # Run at 6:00 AM UTC daily (was 10:00 UTC)
  workflow_dispatch:      # Allow manual trigger for testing

jobs:
  daily-update:
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Trigger House FD Pipeline (Step Functions)
      run: |
        YEAR=$(date +%Y)
        echo "Starting House FD Pipeline for year $YEAR..."
        
        # Start Step Functions execution and capture the ARN
        EXECUTION_ARN=$(aws stepfunctions start-execution \
          --state-machine-arn ${{ secrets.HOUSE_FD_STATE_MACHINE_ARN }} \
          --name "daily-incremental-$(date +%Y%m%d-%H%M%S)" \
          --input "{\"execution_type\":\"scheduled\",\"year\":$YEAR}" \
          --query 'executionArn' \
          --output text)
        
        echo "Execution started: $EXECUTION_ARN"
        
        # Wait for completion with timeout (2 hours max)
        START_TIME=$(date +%s)
        TIMEOUT_SECONDS=7200
        
        while true; do
          ELAPSED=$(($(date +%s) - START_TIME))
          
          if [ $ELAPSED -ge $TIMEOUT_SECONDS ]; then
            echo "⏱️ Pipeline execution timed out after $ELAPSED seconds"
            exit 1
          fi
          
          STATUS=$(aws stepfunctions describe-execution \
            --execution-arn "$EXECUTION_ARN" \
            --query 'status' \
            --output text)
          
          echo "[$ELAPSED s] Current status: $STATUS"
          
          if [ "$STATUS" = "SUCCEEDED" ]; then
            echo "✅ Pipeline completed successfully"
            
            # Get execution output
            OUTPUT=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'output' \
              --output text)
            echo "Execution output: $OUTPUT"
            exit 0
          elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "TIMED_OUT" ] || [ "$STATUS" = "ABORTED" ]; then
            echo "❌ Pipeline failed with status: $STATUS"
            
            # Get failure details
            ERROR=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'error' \
              --output text)
            CAUSE=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'cause' \
              --output text)
            
            echo "Error: $ERROR"
            echo "Cause: $CAUSE"
            exit 1
          fi
          
          # Wait 30 seconds before checking again
          sleep 30
        done

