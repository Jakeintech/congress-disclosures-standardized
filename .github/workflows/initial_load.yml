name: Initial Load (Full Reset)

on:
  workflow_dispatch:
    inputs:
      year:
        description: 'Year to process'
        required: true
        default: '2025'
      confirm_reset:
        description: 'Type "RESET" to confirm full data wipe'
        required: true

jobs:
  initial-load:
    runs-on: ubuntu-latest
    if: inputs.confirm_reset == 'RESET'
    
    permissions:
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-1

    - name: Trigger House FD Pipeline (Step Functions)
      run: |
        YEAR="${{ inputs.year }}"
        echo "Starting House FD Pipeline for year $YEAR (initial load)..."
        
        # Start Step Functions execution and capture the ARN
        EXECUTION_ARN=$(aws stepfunctions start-execution \
          --state-machine-arn ${{ secrets.HOUSE_FD_STATE_MACHINE_ARN }} \
          --name "initial-load-$YEAR-$(date +%Y%m%d-%H%M%S)" \
          --input "{\"execution_type\":\"manual\",\"year\":$YEAR}" \
          --query 'executionArn' \
          --output text)
        
        echo "Execution started: $EXECUTION_ARN"
        
        # Wait for completion with timeout (2 hours max)
        TIMEOUT=$((SECONDS + 7200))
        
        while [ $SECONDS -lt $TIMEOUT ]; do
          STATUS=$(aws stepfunctions describe-execution \
            --execution-arn "$EXECUTION_ARN" \
            --query 'status' \
            --output text)
          
          echo "Current status: $STATUS"
          
          if [ "$STATUS" = "SUCCEEDED" ]; then
            echo "✅ Pipeline completed successfully"
            
            # Get execution output
            OUTPUT=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'output' \
              --output text)
            echo "Execution output: $OUTPUT"
            exit 0
          elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "TIMED_OUT" ] || [ "$STATUS" = "ABORTED" ]; then
            echo "❌ Pipeline failed with status: $STATUS"
            
            # Get failure details
            ERROR=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'error' \
              --output text)
            CAUSE=$(aws stepfunctions describe-execution \
              --execution-arn "$EXECUTION_ARN" \
              --query 'cause' \
              --output text)
            
            echo "Error: $ERROR"
            echo "Cause: $CAUSE"
            exit 1
          fi
          
          # Wait 30 seconds before checking again
          sleep 30
        done
        
        echo "⏱️ Pipeline execution timed out after 2 hours"
        exit 1

